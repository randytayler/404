<html><head><title>Human Not Found</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<script src="https://js13kgames.com/webxr-src/2020/aframe.js"></script>
	<script src="aframe-teleport-controls-reduced.js"></script><script src="zzfx.micro.js"></script>
<script>
var junk = '';
function shuffle(array) {
	for (let i = array.length - 1; i > 0; i--) {
		const j = Math.floor(Math.random() * (i + 1));
		[array[i], array[j]] = [array[j], array[i]];
	}
	return array;
}
var talking = false;
function ss(val,id){
	var vol = getVol(id)*2;
	var lines = [[vol,0,205,,.36,.39,1,1.58,,-0.1,,.02,,,-0.1,,,.96,.08],[vol,,212,.43,.07,.97,2,.94,,-0.1,-7,.04,.08,,,,,.61,.06],[vol,,444,.17,.36,.3,2,.23,,.1,-3,.02,.19,,-0.2,,,.74,.04],[vol,,288,,.28,.26,,.57,,,-248,.07,.3,,,,,.75,.03],[vol,,579,.28,.36,.17,1,.53,-1,2.9,5,.06,.25,,,,,.69],
		[vol,,239,,.43,.2,,1.7,,,729,.02,.06,,,.1,,.88,.06],
		[vol,,395,.15,.02,.46,,1.03,,,550,.04,.09,,,,,,.01],
		[vol,,39,.17,.28,.25,,1.11,,,750,.09,.02,,,.1,,,.05],
		[vol,,584,.21,.36,.86,,1.77,,,-157,.02,.1,.1,,,,.82,.08],
		[vol,,948,.37,.38,.24,,1.52,4.9,,270,.07,.27,,-0.2,,,.85,.02],
		[vol,,727,,.09,.19,,1.55,,,-100,.1,,,,.1,,,.03]
	];
	var titles = ['Darn...','Human not found.','Where\'d you go?','Uh-oh...','Please come back.',
		'I found you.','Get back to sick bay!','Target found.','Returning patient to medbay.','Targeting...','Teleporting.'
	];
	if (talking != val){
		talking = val;
		zzfx(...lines[val]);
		document.querySelector("#log").setAttribute('text','value:'+titles[val]);
	}
}
var height=4;
var width=4;
var holoImage,gameMap,gameMap2,gameMap3,floorMat;
var map1a = ",,26,,;,,8,,,;133,5,,,;,,8,,;,,74,,";
var map1b = ",,56,,;,,24,152,;29,24,25,24,24;,,24,88,;,,24,,";
var map1c = ",,,,;,,,,;2,,,,;,,,,;,,,,";

var map2a = ",,,,26,;,,26,,10,;133,5,,5,,5;,,74,,10;,,,,74,";
var map2b = ",,,64,24,;,,24,,24,;29,24,24,24,25,24;,,24,,24,;,,,128,24,";
var map2c = ",,,,,;,,,,,;2,,,,,;,,,,,;,,,,,";

var map3a = ",,16,,,;,,14,,,;128,7,,13,,,;,,11,,,;,,64,,,";
var map3b = ",88,24,152,,,;88,88,25,152,152,;24,27,,25,24,;152,152,25,88,88,;,152,24,88,,";
var map3c = ",,,,,,;,,1,,,,;,8,,2,,,;,,4,,,,;,,,,,,";

var map4a = ",,,16,16,,;,,8,,,2,;133,5,,5,5,,5;,,8,,,2,;,,,64,64,,";
var map4b = ",,88,25,24,152,;,,24,88,152,24,;29,24,24,24,24,24,25;,,24,152,88,24,;,,152,24,25,88,";
var map4c = ",,,,,,;,,,,,,;2,,,,,,;,,,,,,;,,,,,,";
var level,startX,startZ,rotY,currenttarget;
var nextMove=Array(3);
var nextTurn=Array(3);
var fireListener=Array(3);
var firing = false;
var loaded = false;
var done = false;
var levels=[[map1a,map1b,map1c,'0,2,90','4,2'],[map2a,map2b,map2c,'0,2,90','6,2'],[map3a,map3b,map3c,'1,2,180','5,2'],[map4a,map4b,map4c,'0,2,180','7,2']];
var botPaths = [
	[[{x:6,z:12},{rot:180},{x:6,z:0},{rot:0}]],
	[[{x:6,z:3},{rot:0},{x:6,z:9},{rot:180}],[{x:12,z:0},{rot:0},{x:12,z:12},{rot:180}]],
	[[{x:0,z:4.5},{rot:360},{x:0,z:7.5},{rot:45},{x:4.5,z:12},{rot:90},{x:7.5,z:12},{rot:135},{x:12,z:7.5},{rot:180},{x:12,z:4.5},{rot:225},{x:7.5,z:0},{rot:270},{x:4.5,z:0},{rot:315}],
        [{x:12,z:7.5},{rot:180},{x:12,z:4.5},{rot:225},{x:7.5,z:0},{rot:270},{x:4.5,z:0},{rot:315},{x:0,z:4.5},{rot:360},{x:0,z:7.5},{rot:45},{x:4.5,z:12},{rot:90},{x:7.5,z:12},{rot:135}]],
	[[{x:9,z:6},{rot:90},{x:15,z:6},{rot:-90}]]
];
var attnames = ['probability','id','position','rotation','scale','class','color','width','height','opacity','src','repeat','animation','font','value','baseline','align','intensity','distance','depth','radius','open-ended','side','segments-height','segments-radial','theta-length','segments','segments-width','segments-tubular','radius-tubular','arc','gaze','raycaster','line','material','transparent'];
function insideellipse(rx, ry, r1, r2, mx, my){
    if (((((rx-mx)*(rx-mx))/(r1*r1)) + (((ry-my)*(ry-my))/(r2*r2))) < 1) return true;
    return false;
}
function nebulainside(rr,rg,rb,x,y,lum,ew,eh,ra,rand,ctx,a){
    var rx = Math.round(Math.random()*1000);
    var ry = Math.round(Math.random()*1000);
    if (insideellipse(rx,ry,ew,eh,x,y)){
        var radius = Math.round(Math.random()*rand);
        var r=Math.round(Math.random()*rr)+lum;
        var g=Math.round(Math.random()*rg)+lum;
        var b=Math.round(Math.random()*rb)+lum;
        if(!a)var a=Math.random()/ra;
        ctx.fillStyle = "rgba("+r+","+g+","+b+","+a+")";
        ctx.beginPath();
        ctx.arc(rx,ry,radius,0, 2*Math.PI,false);
        ctx.fill();
    }
}
function nebula(rr,rg,rb,x,y,lum,a){
    var c=document.getElementById('nebula');
    var ctx=c.getContext('2d');
    for (i=0;i<1000;i++)nebulainside(rr,rg,rb,x,y,lum,200,200,10,6,ctx,a);
    for (i=0;i<2000;i++)nebulainside(rr,rg,rb,x,y,lum,150,150,5,3,ctx,a);
    for (i=0;i<2000;i++)nebulainside(rr,rg,rb,x,y,lum,100,100,5,3,ctx,a);
    for (i=0;i<100;i++)nebulainside(rr,rg,rb,x,y,lum,50,50,10,50,ctx,a);
    for (i=0;i<100;i++)nebulainside(rr,rg,rb,x,y,lum,50,50,10,50,ctx,a);
}
function noise(max,xrange,yrange,rr,rg,rb,rplus,gplus,bplus,ctx,a){
    for (i=0; i<=max; i++){
        var rx = Math.round(Math.random()*xrange);
        var ry = Math.round(Math.random()*yrange);
        var radius = Math.round(Math.random()*2);
        var r=Math.round(Math.random()*rr)+rplus;
        var g=Math.round(Math.random()*rg)+gplus;
        var b=Math.round(Math.random()*rb)+bplus;
        if(!a)a=1;
        ctx.fillStyle = "rgba("+r+","+g+","+b+","+a+")";
        ctx.beginPath();
        ctx.arc(rx,ry,radius,0, 2*Math.PI,false);
        ctx.fill();
    }
}
function buildStars() {
    var c=document.getElementById('stars');
    var ctx=c.getContext('2d');
    ctx.fillStyle = "rgba(0,0,0,255)";
    ctx.fillRect(0,0,1024,1024);
    noise(10000,1024,1024,15,15,35,0,0,0,ctx);
    var nebulaCanvas=document.getElementById('nebula');
    var nebulaCtx = nebulaCanvas.getContext("2d");

    for (var j=0; j<10; j++){
        nebulaCtx.clearRect(0,0,1024,1024);
        var startX = startY = 512;
        var delta=1;
        var r=Math.round(Math.random()*155);
        var g=Math.round(Math.random()*155);
        var b=Math.round(Math.random()*155);
        for (var i=0; i<10; i++){
            nebula(r,g,b,startX,startY,100,false);
            delta=Math.round(Math.random()*150)-75;
            startX+=delta*((Math.random()*2)-1);
            startY+=delta*((Math.random()*2)-1);
            if(startX>950)startX-=500;
            if(startX<50)startX=500;
            if(startY>950)startY=500;
            if(startY<50)startY=500;
        }
        var x = Math.round(Math.random()*524)-250;
        var y = Math.round(Math.random()*524)-250;
        ctx.drawImage(nebulaCanvas,x,y);
    }
	noise(10000,4096,4096,55,55,55,200,200,200,ctx);
}
function land(ctx,x,y,minX,minY,midX,midY,maxX,maxY,step){
    ctx.beginPath();
    ctx.moveTo(x,y);
    while (x < midX){
        x+=Math.round(Math.random()*step);
        y-=Math.round(Math.random()*step);
        if(y<minY)y+=20;
        if(x>=midX)x=midX;
        ctx.lineTo(x,y);
    }
    while (x < maxX){
        x+=Math.round(Math.random()*step);
        y+=Math.round(Math.random()*step);
        if(y>midY)y-=10;
        if(x>=maxX)x=maxX;
        ctx.lineTo(x,y);
    }
    while (x > midX){
        x-=Math.round(Math.random()*step);
        y+=Math.round(Math.random()*step);
        if(y>maxY)y-=20;
        if(x<=midX)x=midX;
        ctx.lineTo(x,y);
    }
    while (x > minX){
        x-=Math.round(Math.random()*step);
        y-=Math.round(Math.random()*step);
        if(y<midY)y+=10;
        if(x<=minX)x=minX;
        ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.fill();
}
function paintEarth(){
    var nebulaCanvas=document.getElementById('nebula');
    var c=document.getElementById('stars');
    var ctx = c.getContext("2d");
    ctx.fillStyle="#233c75";
    ctx.fillRect(0,0,1024,1024);

    var grd = ctx.createLinearGradient(300,300,600,800);
    grd.addColorStop(0, '#b59f87');
    grd.addColorStop(.2, '#41561e');
    grd.addColorStop(.5, '#33441e');
    grd.addColorStop(.8, '#41561e');
    grd.addColorStop(1, '#b59f87');
    ctx.fillStyle=grd;
    land(ctx,200,500,200,200,500,500,800,700,10);
    ctx.fillStyle="#233c75";
    land(ctx,600,600,400,400,500,500,700,700,10);
    ctx.fillStyle="#233c75";
    land(ctx,600,500,600,300,500,450,700,600,10);
    ctx.fillStyle="#eeeeee";
    land(ctx,350,500,300,300,350,450,400,600,10);
    ctx.fillStyle=grd;
    land(ctx,700,200,700,100,800,300,900,400,10);
    ctx.fillStyle="#33441e";
    land(ctx,100,200,50,100,100,900,150,900,10);
    ctx.fillStyle="#fff";
    land(ctx,300,0,300,-50,450,0,700,300,10);
    noise(10000,1024,1024,255,255,255,0,0,0,ctx,.02);

    nebula(0,0,0,500,500,255,.1);
    nebula(0,0,0,500,500,255,.1);
    nebula(0,0,0,500,500,255,.1);
    nebula(0,0,0,500,500,255,.1);
    ctx.drawImage(nebulaCanvas,-200,-200);
    ctx.drawImage(nebulaCanvas,-200,-200);
    ctx.drawImage(nebulaCanvas,100,300);
    ctx.drawImage(nebulaCanvas,100,300);
    document.querySelector("#winplanet").setAttribute('src',c.toDataURL("image/png"));
}
function asteroids(){
    for(var j=-1;j<=1;j+=2){
        for(var i = 1; i <= 5; i++){
            var x = j<0?(-2*i-5):(2*i+20);
            var y = Math.random()*10-5;
            var z = Math.random()*15+10-i*2;
            var xs = Math.random() + .5;
            var ys = Math.random() + .5;
            var zs = Math.random() + .5;
            buildEntity({
                type: 'a-sphere',
                attributes: ',asteroid' + i + '_'+j+',' + x + ' ' + y + ' ' + z + ',,'+xs+' '+ys+' '+zs+',,#111,,,,,,,,,,,,,,,,,4,,,,4'
            }, document.querySelector("#a-scene"));
            document.querySelector("#asteroid"+i+'_'+j).setAttribute('animation', 'property:rotation;to:360 0 0;loop:true;dur:'+(i*3000)+';easing:linear');
            document.querySelector("#asteroid"+i+'_'+j).setAttribute('animation__2', 'property:position;from:'+x+' '+y+' '+z+';to:'+x+' '+y+' -15;loop:true;dur:'+(i*3000)+';easing:linear');
        }
    }
}
function buildFloor() {
    var c128=document.getElementById('c128');
    var ctx=c128.getContext('2d');
    ctx.fillStyle = "rgba(157,157,157,1)";
    ctx.fillRect( 0, 0, 128, 128 );
    noise(1000,128,128,25,25,25,150,150,150,ctx);
    for (i=0; i<128; i+=64){
        ctx.strokeStyle = "rgba(90,90,90,1)";
        ctx.beginPath();
        ctx.moveTo(0,i);
        ctx.lineTo(i,0);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(128,i);
        ctx.lineTo(i, 128);
        ctx.stroke();
        ctx.strokeStyle = "rgba(200,200,200,1)";
        ctx.beginPath();
        ctx.moveTo(i,0);
        ctx.lineTo(128,128-i);
        ctx.stroke();
        ctx.strokeStyle = "rgba(50,50,50,1)";
        ctx.beginPath();
        ctx.moveTo(i+2,0);
        ctx.lineTo(128,128-(i+2));
        ctx.stroke();
        ctx.strokeStyle = "rgba(200,200,200,1)";
        ctx.beginPath();
        ctx.moveTo(i,128);
        ctx.lineTo(0,128-i);
        ctx.stroke();
        ctx.strokeStyle = "rgba(50,50,50,1)";
        ctx.beginPath();
        ctx.moveTo(i+2,128);
        ctx.lineTo(0,128-(i+2));
        ctx.stroke();
    }
    floorMat = c128.toDataURL("image/png");
}
function buildMap(){
	var map = levels[level][0];
	start=levels[level][3].split(',');
	startX=parseInt(start[0]);
	startZ=parseInt(start[1]);
	rotY=parseInt(start[2]);
	var rows = map.split(";");
	gameMap = new Array(rows.length);
	gameMap2 = new Array(rows.length);
    gameMap3 = new Array(rows.length);
	for (var row in rows){
		cols = rows[row].split(",");
		gameMap[row] = cols;
	}
	rows = levels[level][1].split(";");
	for (var row in rows){
		cols = rows[row].split(",");
		gameMap2[row] = cols;
	}
    rows = levels[level][2].split(";");
    for (var row in rows){
        cols = rows[row].split(",");
        gameMap3[row] = cols;
    }
}
function buildShip(){
	for (var row in gameMap){
		for (var col in gameMap[row]){
			walls = gameMap[row][col];
			walls2 = gameMap2[row][col];
            walls3 = gameMap3[row][col];
			if (walls & 1){
				wall(col*3, 1, -1.45 + row*3, 270, 'wn'+row+'_'+col);
			}
			if (walls & 2){
				wall(1.45 + col*3, 1, row*3, 180, 'we'+row+'_'+col);
			}
			if (walls & 4){
				wall(col*3, 1, 1.45 + row*3, 90, 'ws'+row+'_'+col);
			}
			if (walls & 8){
				wall(-1.45 + col*3, 1, row*3, 0, 'ww'+row+'_'+col);
			}
			if (walls & 16){
				windo(col*3, 1, -1.45 + row*3, 90, 'win'+row+'_'+col);
			}
			if (walls & 32){
				windo(1.45 + col*3, 1, row*3, 0, 'win'+row+'_'+col);
			}
			if (walls & 64){
				windo(col*3, 1, 1.45 + row*3, 270, 'win'+row+'_'+col);
			}
			if (walls & 128){
				windo(-1.45 + col*3, 1, row*3, 180, 'win'+row+'_'+col);
			}
			if (walls2 & 1){
				light(col*3,row*3);
			}
			if (walls2 & 2){
                cryo(1+col*3, .5, row*3, 90);
			}
			if (walls2 & 4){
				cryo(col*3, .5, 1+row*3, 0);
			}
			if (walls2 & 8){
				layFloor(col,row);
			}
			if (walls2 & 16){
				buildEntity({type:'a-plane',attributes:',,'+col*3+' 2 '+row*3+',-270 0 0,,ceiling,#ccc,3,3'},document.querySelector('#ship'));
			}
			if (walls2 & 32){
				table(1.1+col*3,.8,row*3);//escape(x,y,z)?
			}
			if (walls2 & 64){
				dwall(col*3, 1, row*3, -45);
			}
			if (walls2 & 128){
				dwall(col*3, 1, row*3, 45);
			}
			if (walls3 & 1){
                doorway(col * 3, 1, row * 3 - 1.5,0);
			}
			if (walls3 & 2) {
                doorway(col * 3 + 1.5, 1, row * 3,90);
            }
            if (walls3 & 4) {
                doorway(col * 3, 1, row * 3 + 1.5,180);
            }
            if (walls3 & 8) {
                doorway(col * 3 - 1.5, 1, row * 3,270);
            }
		}
	}
    document.querySelector("#log").setAttribute('text','value:Time to wake up...');
}
function buildButtons(){
    for(var levelId in levels){
        buildEntity({type:'a-plane',attributes:',level'+parseInt(levelId)+','+(-1+(levelId*.55))+' 1 -2,,,button,#ff2,.5,.1,.5',children:[{type:'a-text',attributes:',,0 .015 .02,,.3 .3 .3,,,,,,,,,exo2semibold,LEVEL '+(parseInt(levelId)+1)+',,center'}]},document.querySelector('#a-scene'));
    }
}
function layFloor(x,z){
    buildEntity({type:'a-plane',attributes:',floor'+x+'_'+z+','+(x*3)+' 0 '+(z*3)+',-90 0 0,,floor,#666,3,3'},document.querySelector('#ship'));
    document.querySelector("#floor"+x+'_'+z).setAttribute('src', floorMat);
    document.querySelector("#floor"+x+'_'+z).setAttribute('repeat', '10 10');
}
function dwall(x,y,z,rotY){
	var dwall=document.createElement('a-entity');
	document.querySelector('#ship').appendChild(dwall);
	wall(0,0,0,0,'',dwall);
	dwall.setAttribute('scale','1 1 1.45');
	dwall.setAttribute('position',x+' '+y+' '+z);
	dwall.setAttribute('rotation','0 '+rotY+' 0');
}
function table(x,y,z){
	buildEntity({type:'a-box',attributes:',,'+x+' '+y+' '+z+',,,,#aaa,.5,.05,,,,,,,,,,,1.1'},document.querySelector('#ship'));
	buildEntity({type:'a-box',attributes:',,'+x+' '+(y-.39)+' '+z+',,,,#777,.1,.8,,,,,,,,,,,.1'},document.querySelector('#ship'));
	buildEntity({type:'a-box',attributes:'.3,,'+(x+.1)+' '+y+' '+(z+.1)+',0 30 0,,,#227,.15,.15,,,,,,,,,,,.1'},document.querySelector('#ship'));
	buildEntity({type:'a-box',attributes:'.3,,'+(x-.1)+' '+(y+.1)+' '+(z-.2)+',0 -20 0,,,#727,.23,.15,,,,,,,,,,,.2'},document.querySelector('#ship'));
}
function cryo(x,y,z,rotY){
	buildEntity({type:'a-cylinder',attributes:',,'+x+' '+y+' '+z+',90 '+(rotY-90)+' 0,,,#77f,,2,.3,,,,,,,,,,,.5,false,double,,,220,,,,,180'},document.querySelector('#ship'));
	buildEntity({type:'a-box',attributes:',,'+x+' '+(y-.25)+' '+z+',0 '+(rotY+90)+' 0,,,#aaa,1.1,.5,,,,,,,,,,,2.1',children:[
		{type:'a-box',attributes:',,,,,,#eee,.9,.55,,,,,,,,,,,1.8,,,,,,,,,,,,,,,shader:flat'},
		{type:'a-text',attributes:',,.55 0 .4,0 90 0,,,,,,,,,,exo2semibold,CRYOPOD 003'},
	]},document.querySelector('#ship'));
}
function doorway(x,y,z,rotY){
    buildEntity({type:'a-entity',attributes:',,'+x+' '+y+' '+z+',0 '+rotY+' 0',children:[
		{type:'a-box',attributes:',,1 0 0,,,,,1,2,,,,,,,,,,,.15'},
		{type:'a-box',attributes:',,-1 0 0,,,,,1,2,,,,,,,,,,,.15'}
	]},document.querySelector('#ship'));
}
function light(x,z){
	var el = document.createElement('a-box');
	el.setAttribute('position',x + ' 2 ' + z);
	el.setAttribute('width', 1);
	el.setAttribute('height', .05);
	el.setAttribute('depth', 1);
	el.setAttribute('color', '#fff');
	el.setAttribute('material', 'shader:flat');
	document.querySelector("#ship").appendChild(el);

	var light = document.createElement('a-light');
	light.setAttribute('type', 'point');
	light.setAttribute('color', '#fff');
	light.setAttribute('intensity', 1);
	light.setAttribute('distance', 2.5);
	el.appendChild(light);
}
function escape(x, y, z) {
    layFloor(x/3,z/3);
	buildEntity({type:'a-plane',attributes:',,'+x+' 2 '+z+',-270 0 0,,ceiling,#ccc,3,3'},document.querySelector('#ship'));
	wall(x, 1, -1.45 + z, 270, 'escaperoomn');
	wall(x, 1, 1.45 + z, 90, 'escaperooms');
	windo(x+1.45, 1, z, 180, 'escaperoomw');
	light(x,z);
	transporter(x, 0, z);
}
function newgame(){
    buildEntity({type:'a-text',attributes:",instructions,-8 0 0,0 90 0,,,#ffff82,,,,,,,exo2semibold,It never fails.\n\nAn emergency alert wakes you up from hibernation~ leaving you still partially paralyzed from an epidural. Apparently~ the ship is going to explode any minute.\n\nGreat.\n\nEven better~ the malfunctioning NurseBots insist you stay in the medbay.\n\nSince you can't walk~ use your handy personal teleporter to evade the bots and get to the evacuation transporter~ to port to the nearby planet's surface before it's too late."},document.querySelector("#a-scene"));
    buildButtons();
}
function endGame(){
	document.querySelector("#a-scene").removeChild(document.querySelector("#ship"));
    document.querySelector("#camera").removeChild(document.querySelector("#timerUI"));
    document.querySelector("#camera").removeChild(document.querySelector("#batteryParentUI"));
    document.querySelector("#rig").setAttribute('position', '0 0 0');
    document.querySelector("#rig").setAttribute('rotation', '0 0 0');
    document.querySelector("#title1").setAttribute('text','value:YOU ARE DEAD.');
    document.querySelector("#titles2").setAttribute('text','value:Your constituent particles have been converted directly to energy, in a very violent fashion.');
    buildButtons();
}
function win(){
    document.querySelector("#a-scene").removeChild(document.querySelector("#ship"));
    document.querySelector("#camera").removeChild(document.querySelector("#timerUI"));
    document.querySelector("#camera").removeChild(document.querySelector("#batteryParentUI"));
    document.querySelector("#rig").setAttribute('position', '0 0 0');
    document.querySelector("#rig").setAttribute('rotation', '0 0 0');
    document.querySelector("#title1").setAttribute('text',"value:HOME SWEET HOME.");
    document.querySelector("#titles2").setAttribute('text',"value:Well, it's SOMEbody's home, at least. Hope this planet is friendly.");
    buildEntity({type:'a-sphere',attributes:',winplanet,0 0 -1000,0 0 10,50 50 50,,,,,,,2 1,property:rotation;to:0 360 10;loop:true;dur:180000;easing:linear'},document.querySelector("#a-scene"));
    paintEarth();
    document.querySelector("#winplanet").setAttribute('animation__2', 'property:position;to:0 0 -120;dur:1000;');
}
function openDoor(){
	var d = document.querySelector('#inner-door');
	d.setAttribute('animation', "property:position;to:0 3 0;loop:false;dur:500;easing:linear");
}
function buildEntity(data, parent){
	var el = document.createElement(data.type);
	if(data.type=='a-light'){
		el.setAttribute('type','point');
	}
	var attributes = data.attributes.split(",");
	if (attributes[0]){
		if (!shouldAddEntity(attributes[0])) return;
	}
	for(i=1;i<attributes.length;i++){
		if (attributes[i]){
			el.setAttribute(attnames[i],attributes[i].replace(/~/g,','));
			if (attnames[i]=='class')el.setAttribute(attributes[i],'');
		}
	}
	parent.appendChild(el);
	for(child in data.children){
		buildEntity(data.children[child],el);
	}
}
function transporter(x, y, z) {
    buildEntity({type:'a-torus',attributes:',transporterBase,'+x+' '+y+' '+z+',90 0 0,,,,,,,,,,,,,,,,,.6,,,,,,,,,.01'},document.querySelector('#ship'));
    var c=document.getElementById("gradient");
    var ctx = c.getContext('2d');
    var grd = ctx.createLinearGradient(0, 0, 0, 1024);
    grd.addColorStop(.1, "rgba(22,22,255,1)");
    grd.addColorStop(.8, "rgba(255,255,255,0");
    ctx.fillStyle = grd;
    ctx.fillRect(0, 0, 1024, 1024);
    var gradientImage = c.toDataURL("image/png");
    buildEntity({type:'a-cylinder',attributes:',transporter,'+x+' '+(y+1)+' '+z+',180 0 0,,,,,2,,,,,,,,,,,,.6,true,double,,,,,,,,,,,,shader:flat,true'},document.querySelector('#ship'));
    document.querySelector("#transporter").setAttribute('src',gradientImage);
}
function buildBot(i,x,z){
	buildEntity({type:'a-entity',attributes:',robot'+i+','+x+' 0 '+z+',0 180 0,,robot',children:[
			{type:'a-entity',attributes:',robotrot'+i+',0 .6 0',children:[
				{type:'a-cylinder',attributes:',,0 0 0,,,,#fff,,1,,,,,,,,,,,,.3,,,12'},
				{type:'a-cylinder',attributes:',,0 .5 0,,,,#000,,.02,,,,,,,,,,,,.31,true,double'},
				{type:'a-cylinder',attributes:',,0 -.5 0,,,,#000,,.02,,,,,,,,,,,,.31,true,double'},
				{type:'a-box',attributes:',,0 .65 0,,.1 .3 .1,,#00f'},
				{type:'a-box',attributes:',,0 .25 -.22,,.3 .45 .3,,#00f'},
				{type:'a-box',attributes:',,0 .25 .25,,.1 .3 .1,,#f00'},
				{type:'a-box',attributes:',,0 .25 .25,,.3 .1 .1,,#f00'},
			]},
		]}
	,document.querySelector("#ship"));
	buildEntity({type:'a-entity',attributes:',headrobot'+i+',0 .8 0,,,,,,,,,,property:rotation;from:0 -15 0;to:0 15 0;loop:true;dur:1000;easing:linear;dir:alternate;pauseEvents:foundPlayer;resumeEvents:fired',
		children:[
		{type:'a-sphere',attributes:',eyerobot'+i+',0 .03 .22,,,,#fff,,,,,,,,,,,,,,.07,,8,,,,8,,,,,,,,shader:flat',children:[
			{type:'a-entity',attributes:',,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,event:foundPlayer~fired,objects:.collidable;showLine:true;direction:0 0 1,opacity:.0'},
			{type:'a-entity',attributes:',,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,event:foundPlayer~fired,objects:.collidable;showLine:true;direction:.3 0 1,opacity:.0'},
			{type:'a-entity',attributes:',,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,event:foundPlayer~fired,objects:.collidable;showLine:true;direction:-.3 0 1,opacity:.0'},
			{type:'a-entity',attributes:',,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,event:foundPlayer~fired,objects:.collidable;showLine:true;direction:.7 0 1,opacity:.0'},
			{type:'a-entity',attributes:',,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,event:foundPlayer~fired,objects:.collidable;showLine:true;direction:-.7 0 1,opacity:.0'},
		]},
		{type:'a-cylinder',attributes:',,0 0 0,0 45 0,,,#fff,,.3,,,,,,,,,,,,.25,,double,,12'},
		{type:'a-cylinder',attributes:',,0 0 0,0 45 0,,,#f00,,.2,,,,,,,,,,,,.26,true,double,,12'},
		{type:'a-cylinder',attributes:',,0 .15 0,0 45 0,,,#000,,.02,,,,,,,,,,,,.26,true,double,,12'},
		{type:'a-cylinder',attributes:',,0 -.15 0,0 45 0,,,#000,,.02,,,,,,,,,,,,.26,true,double,,12'}
		]
	},document.querySelector("#robotrot"+i));
	buildEntity({type:'a-sphere',attributes:',leftarm,.35 .4 0,-30 0 0,,,#000,,,,,,property:rotation;from:0 0 0;to:30 0 0;loop:true;dur:1000;easing:linear;dir:alternate,,,,,,,,.07,,,8,,,,8',
					children:[
						{type:'a-cylinder',attributes:',,0 -.15 0,0 45 0,,,,,.3,,,,,,,,,,,,.06,,,,6'},
						{type:'a-sphere',attributes:',,0 -.3 0,-30 0 0,,,#000,,,,,,,,,,,,,,.07,,,8,,,,8',children:[{type:'a-cylinder',attributes:',,0 -.15 0,0 45 0,,,,,.3,,,,,,,,,,,,.04,,,,6',children:[{type:'a-cylinder',attributes:',,0 -.16 0,90 -45 -45,1.6 1 1.5,,#fff,,.08,,,,,,,,,,,,.04,,double,,5,300'}]}]}
					]},document.querySelector("#robotrot"+i));
	buildEntity({type:'a-sphere',attributes:',rightarm,-.35 .4 0,-30 0 0,,,#000,,,,,,property:rotation;from:30 0 0;to:0 0 0;loop:true;dur:1000;easing:linear;dir:alternate,,,,,,,,.07,,,8,,,,8',
					children:[
						{type:'a-cylinder',attributes:',,0 -.15 0,0 45 0,,,,,.3,,,,,,,,,,,,.06,,,,6'},
						{type:'a-sphere',attributes:',,0 -.3 0,-30 0 0,,,#000,,,,,,,,,,,,,,.07,,,8,,,,8',children:[{type:'a-cylinder',attributes:',,0 -.15 0,0 45 0,,,,,.3,,,,,,,,,,,,.04,,,,6',children:[{type:'a-cylinder',attributes:',,0 -.16 0,90 45 -45,1.6 1 1.5,,#fff,,.08,,,,,,,,,,,,.04,,double,,5,300'}]}]}
					]},document.querySelector("#robotrot"+i));

	var botlight = document.createElement('a-light');
	document.querySelector("#eyerobot"+i).appendChild(botlight);
	botlight.setAttribute('id','botlightrobot'+i);
	botlight.setAttribute('position', '0 -.2 1');
	botlight.setAttribute('intensity',.5);
	botlight.setAttribute('type','point');
	botlight.setAttribute('color','#fff');
	botlight.setAttribute('distance',2);
}
function draw(){
    for(var b in botPaths[level]) {
        buildBot(b, botPaths[level][b][0].x, botPaths[level][b][0].z);
    }
	startPos=levels[level][3].split(',');
	exitPos=levels[level][4].split(',');
    doorX=exitPos[0]*3;
	doorZ=exitPos[1]*3;
	door(doorX-1.5,1,doorZ,0,'door');
	escape(doorX, 0, doorZ);
	var c2 = document.getElementById("holocanvas");
	var ctx2 = c2.getContext("2d");
	ctx2.font = 300+'px serif';
	ctx2.textAlign = 'center';
	ctx2.fillText('🙋️',300,400);
	holoImage = c2.toDataURL("image/png");
	//document.querySelector('#holo').setAttribute('src', holoImage);
}
function deleteWall(name){if(document.querySelector("#"+name))document.querySelector("#"+name).parentNode.removeChild(document.querySelector("#"+name));}
function door(x, y, z, roty, id){
    buildEntity({type:'a-entity',attributes:','+id+','+x+' '+y+' '+z+',0 '+roty+' 0',children:[
					{type:'a-box',attributes:',,0 0 1.2,,,collidable,#fff,.2,2,,,,,,,,,,,.6'},
					{type:'a-box',attributes:',,0 0 -1.2,,,collidable,#fff,.2,2,,,,,,,,,,,.6'}
				]},document.querySelector("#ship"));
	buildEntity({type:'a-entity',attributes:',innerdoor,'+x+' '+y+' '+z+',0 '+roty+' 0,,door',children:[
					{type:'a-cylinder',attributes:',hitbox,-.01 0 .75,0 0 90,,,#900,,.12,,,,,,,,,,,,.15',children:[
						{type:'a-text',attributes:',,.02 .07 -.12,-90 270 0,.4 .4 .4,,,,,,,,,exo2semibold,OPEN'},
					]},
					{type:'a-box',attributes:',,0 0 .8,,,,#999,.08,2,,,,,,,,,,,.5'},
					{type:'a-box',attributes:',,0 0 -.8,,,,#999,.08,2,,,,,,,,,,,.5'},
					{type:'a-box',attributes:',,0 .9 0,,,,#999,.08,.2,,,,,,,,,,,1.4'},
					{type:'a-box',attributes:',,0 -.8 0,,,,#999,.08,.5,,,,,,,,,,,1.4'},
					{type:'a-plane',attributes:',,0 .2 0,180 90 0,,collidable,#00f,1.4,1.5,.8,,,,,,,,,,,,,double,,,,,,,,,,,,,true'},
					{type:'a-text',attributes:',,-.01 .5 0,0 270 0,2 2.5 2,,#fff,3,,,,,,exo2semibold,EXIT,top,center'},
                ]},document.querySelector("#ship"));
}
function windo(x, y, z, roty, id) {
    buildEntity({type:'a-entity',attributes:','+id+','+x+' '+y+' '+z+',0 '+roty+' 0',children:[
            {type:'a-plane',attributes:',,,0 90 0,,collidable,,3,2,.1,,,,,,,,,,,,,double'},
            {type:'a-box',attributes:',,0 .9 0,,,,#fff,.2,.2,,,,,,,,,,,3'},
            {type:'a-cylinder',attributes:'.5,,0 .68 .75,22.5 0 90,,,#999,,.22,,,,,,,,,,,,.1,,,,8'},
            {type:'a-box',attributes:',,0 -1 0,,,,#fff,.2,1,,,,,,,,,,,3'},
            {type:'a-box',attributes:',,0 0 1.2,,,,#fff,.2,2,,,,,,,,,,,.7'},
            {type:'a-box',attributes:',,0 0 -1.2,,,,#fff,.2,2,,,,,,,,,,,.7'},
            {type:'a-box',attributes:',,0 .8 .65,45 0 0,,,#fff,.2,.3,,,,,,,,,,,2'},
            {type:'a-box',attributes:',,0 -.7 -.5,45 0 0,,,#fff,.2,.3,,,,,,,,,,,2'},
            {type:'a-torus',attributes:',,0 .1 0,0 90 0,,,#999,,,,,,,,,,,,,,.5,,,,4,,,,6,.01,360'},
            {type:'a-cylinder',attributes:',,0 .1 .7,0 90 90,,,#999,,.4,,,,,,,,,,,,.015,,,,6'},
            {type:'a-cylinder',attributes:',,0 .1 -.7,0 90 90,,,#999,,.4,,,,,,,,,,,,.015,,,,6'},
            {type:'a-cylinder',attributes:',,0 .74 0,0 90 0,,,#999,,.4,,,,,,,,,,,,.015,,,,6'},
            {type:'a-cylinder',attributes:',,0 -.54 0,0 90 0,,,#999,,.4,,,,,,,,,,,,.015,,,,6'},
            {type:'a-plane',attributes:'.5,,-.102 0 -1.05,0 270 0,,,#999,.1,1.55'},
            {type:'a-plane',attributes:',,-.102 -.725 -.12,0 270 0,,,#999,1.95,.1'},
        ]
    },document.querySelector('#ship'));
}
function shouldAddEntity(prob){
    return Math.random()>=prob;
}
function wall(x, y, z, roty, id, parent) {
    if(!parent)parent=document.querySelector("#ship");
    buildEntity({type:'a-box',attributes:','+id+','+x+' '+y+' '+z+',0 '+roty+' 0,,collidable,,.1,2,,,,,,,,,,,3',children:[
            {type:'a-plane',attributes:'.5,,.055 0 .3,0 90 0,,,#444,.3,2'},
            {type:'a-plane',attributes:'.5,,.055 0 .6,0 90 0,,,#444,.1,2'},
            {type:'a-plane',attributes:'.5,,.055 0 .9,0 90 0,,,#444,.3,2'},
            {type:'a-cylinder',attributes:'.5,,0 .83 0,0 90 90,,,#005,,3.01,,,,,,,,,,,,.065,,,,8',children:[
                    {type:'a-cylinder',attributes:',,0 -1.2 0,,,,#222,,.1,,,,,,,,,,,,.07,,,,8'},{type:'a-cylinder',attributes:',,0 1.3 0,,,,#222,,.1,,,,,,,,,,,,.07,,,,8'},{type:'a-cylinder',attributes:',,0 1.1 0,,,,#222,,.1,,,,,,,,,,,,.07,,,,8'}
                ]},
            {type:'a-cylinder',attributes:'.5,,0 -.75 0,0 90 90,,,#66F,,3.01,,,,,,,,,,,,.12,,,,8',children:[
                    {type:'a-cylinder',attributes:',,0 -1 0,,,,#222,,.1,,,,,,,,,,,,.13,,,,8'},{type:'a-cylinder',attributes:',,0 0 0,,,,#222,,.1,,,,,,,,,,,,.13,,,,8'},{type:'a-cylinder',attributes:',,0 1.1 0,,,,#222,,.1,,,,,,,,,,,,.13,,,,8'}
                ]},
            {type:'a-box',attributes:'.5,,0 -.25 -.5,,,,#C99,.12,.2,,,,,,,,,,,.8'},
            {type:'a-box',attributes:'.5,,0 -.45 -.5,,,,#9c9,.12,.2,,,,,,,,,,,.8'},
            {type:'a-box',attributes:'.5,,0 .27 0,,,,#000,.15,.7,,,,,,,,,,,2.5',children:[
                    {type:'a-text',attributes:',,.08 0 1.2,0 90 0,,wallscreen,#f00,3,,,,,,exo2semibold,,top'}
                ]}
        ]},parent);
}
function collided(controllerX, controllerY, controllerZ, globalPos, target){
    var targetWidth = parseFloat(target.getAttribute('width'));
    var targetHeight = parseFloat(target.getAttribute('height'));
    var targetDepth = parseFloat(target.getAttribute('depth'));
    if ((controllerX > (parseFloat(globalPos.x)  - targetWidth)) &&
        (controllerX < (parseFloat(globalPos.x)  + targetWidth)) &&
        (controllerY > (parseFloat(globalPos.y)  - targetHeight)) &&
        (controllerY < (parseFloat(globalPos.y)  + targetHeight)) &&
        (controllerZ > (parseFloat(globalPos.z)  - targetDepth)) &&
        (controllerZ < (parseFloat(globalPos.z)  + targetDepth)))
    {
        return true;
    }
    return false;
}
function getVol(id){
    var eye = document.querySelector("#eye"+id);
    var worldPos = new THREE.Vector3();
    eye.object3D.getWorldPosition(worldPos);
    var player = document.querySelector("#camera");
    dx = worldPos.x-player.object3D.position.x;
    dz = worldPos.z-player.object3D.position.z;
    dh = Math.sqrt(dx*dx + dz*dz);
    return 1/dh;
}
function teleport(){
    //zzfx(...[,.2,835,.24,.23,.23,1,.8,-2.1,1.3,-163,.06,.09,,,,,.87,.06]);
    //zzfx(...[,,987,.03,.17,.95,,.28,-0.1,,154,.06,.06,,,,.15,.86,.03]);

    var target = document.querySelector("#"+currenttarget);
    document.querySelector('#transporter').setAttribute('position', target.object3D.position.x+' 1 '+target.object3D.position.z);
    setTimeout(finishTeleport, 150);
}
function finishTeleport(){
    if(currenttarget=='player')document.querySelector("#rig").setAttribute('position', startX*3+' 0 '+startZ*3);
    var t=document.querySelector('#transporterBase');
    document.querySelector('#transporter').setAttribute('position', t.object3D.position.x+' 1 '+t.object3D.position.z);
}
function fireSound(id){
    zzfx(...[getVol(id),0,214,.01,.01,.5,4,.6,-0.1,1,,,.05,.1,3,,.13,1.28,.05]);
    //setTimeout(explode, 500);
    setTimeout(teleport, 100);
}
function laser(id){
    var eye = document.querySelector("#eye"+id);
    eye.setAttribute('color', '#99F');
    document.querySelector("#botlight"+id).setAttribute('color', '#99F');
    var worldPos = new THREE.Vector3();
    eye.object3D.getWorldPosition(worldPos);
    var target = document.querySelector("#"+currenttarget);
    var line = document.createElement("a-entity");
    line.setAttribute('line', {start:worldPos.x + ' ' + worldPos.y + ' ' + worldPos.z,end:target.object3D.position.x + ' 1 ' +target.object3D.position.z, color:'blue'});
    line.setAttribute('id', 'laser'+id);
    document.querySelector("#a-scene").appendChild(line);
    setTimeout(function(){endLaser(id)}, 100);
}
function endLaser(id){
    el = document.querySelector("#laser"+id);
    if (el) {
        var eye = document.querySelector("#eye"+id);
        eye.setAttribute('color', 'white');
        document.querySelector("#botlight"+id).setAttribute('color', '#fff');
        el.parentNode.removeChild(el);
    }
}
function fire(id){
    fireSound(id);
    laser(id);
    var robot = document.querySelector('#'+id);
    robot.emit('fired',{},true);
    var el = document.querySelector("#head"+id);
    el.emit('fired',{},false);
    el.removeAttribute('animation__vibrate');
    robot.removeEventListener('animationcomplete__vibrate', fireListener[id]);
    //robot.components.robot.data.speed=robot.components.robot.data.speed-250;
    //if (robot.components.robot.data.speed<=250) robot.components.robot.data.speed=250;
    firing = false;
}
function warmUp(id){
    if (!firing) {
        firing = true;
        zzfx(...[getVol(id),0,24,1,.27,.05,2,,,8.2,20,.08,.12,,.05,,,.97,.05]);
        var el = document.querySelector("#head"+id);
        elPos = el.object3D.position;
        el.setAttribute('animation__vibrate', {property:'position',from:elPos.x+' .78 '+elPos.z,to:elPos.x+' .8 '+elPos.z,loop:17,dur:100});
        el.addEventListener('animationcomplete__vibrate', fireListener[id]=function(){fire(id)});
    }
}
function getJunk(){
    if (junk==''){
        var characters='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789             ';
        for (var lines = 0; lines<=18; lines++){
            for (var i = 0; i < Math.random()*400+10; i++) {
                junk+=characters.charAt(Math.floor(Math.random() * characters.length));
            }
            junk+="\n";
        }
    }
    return junk;
}
function distance(pos1, pos2){
    var distX = pos1.x - pos2.x;
    var distZ = pos1.z - pos2.z;
    var dist = Math.round(Math.sqrt((distX * distX) + (distZ * distZ))*100)/100;
    return dist - .25;
}
function hitPlayer(robotPos, lineEnd){
    var camera = document.querySelector("#rig");
    return (distance(camera.object3D.position, robotPos) <= Math.round(lineEnd.z*100)/100)
}
function loadLevel(levelLocal){
    if (!loaded) {
        loaded=true;
        document.querySelector("#log").setAttribute('text', 'value:LOADING...');
        level = levelLocal;
        buildMap();
        buildShip();
        draw();
        document.querySelector("#newgame").parentNode.removeChild(document.querySelector("#newgame"));
        document.querySelector("#title1").setAttribute('text','value:');
        document.querySelector("#title2").setAttribute('text','value:');
        document.querySelector("#title3").setAttribute('text','value:');
        document.querySelector("#titles2").setAttribute('text','value:');
        document.querySelector("#rig").setAttribute('position', startX * 3 + ' 0 ' + startZ * 3);
        document.querySelector("#rig").setAttribute('rotation', '0 ' + rotY + ' 0');
        buildEntity({type:'a-text',attributes:',batteryParentUI,-.3 .15 -.6,,.2 .2 .2,,,,,.7,,,,exo2semibold,BATTERY',children:[
                {type:'a-plane',attributes:',,1.5 -.04 -.01,,,,#fff,1,.15,.4,,,,,,,,,,,,,,,,,,,,,,,,,shader:flat'},
				{type:'a-plane',attributes:',batteryUI,1.5 -.04 0,,,,#ff0,1,.15,.8,,,,,,,,,,,,,,,,,,,,,,,,,shader:flat'}
			]},document.querySelector("#camera"));

        buildEntity({type:'a-text',attributes:',timerUI,.2 .15 -.6,,.2 .2 .2,timer,,,,.7,,,,exo2semibold,1:30'},document.querySelector("#camera"));
        document.querySelector("#game").components.game.data.batteryUI=document.querySelector("#batteryUI");
        document.querySelector("#game").components.game.data.batteryParentUI=document.querySelector("#batteryParentUI");
        document.querySelector("#log").setAttribute('text', 'value:');
    }
}
AFRAME.registerComponent('timer', {
    schema:{
        lastTime:{type:'float'},
        timeLeft:{type:'int',default:90},
		ui:{type:'selector'}
	},
	init: function(){
        var el = this.el;
        this.data.ui = el;
        this.data.lastTime = Math.floor(Date.now()/1000);
	},
	tick: function(){
		var newTime = Math.floor(Date.now()/1000);
		if (newTime > this.data.lastTime) {
		    var timePassed = this.data.timeLeft - (newTime-this.data.lastTime);
		    if (timePassed <= 10) this.data.ui.setAttribute('color', '#f00');
            this.data.timeLeft = timePassed;
            if (timePassed < 0 && !done) {
                //win();
                endGame();
			}
		    this.data.lastTime = newTime;
		    var minutes = Math.floor(timePassed/60);
		    var seconds = timePassed % 60;
		    if (seconds < 10) seconds = '0' + seconds;
		    this.data.ui.setAttribute('value', minutes+':'+seconds);
		}
	}
});
AFRAME.registerComponent('button', {
    schema:{
        id:{type:'string'},
		level:{type:'int'}
	},
    init: function(){
        var el = this.el;
        if (el.getAttribute('id')=='newgame'){
            el.addEventListener('click', function(){
                document.querySelector("#rightController").removeAttribute('laser-controls');
                newgame();
            });
		} else {
			this.data.level = parseInt(el.getAttribute('id').replace(/level/,''));
			el.addEventListener('click', function(){
				document.querySelector("#rightController").removeAttribute('laser-controls');
				loadLevel(el.components.button.data.level);
			});
        }
    }
});
AFRAME.registerComponent('game', {
	schema: {
		timer:{type:'int',default:0},
		battery:{default:100},
		batteryUI:{type:'selector'},
		batteryParentUI:{type:'selector'}
	},
	init: function() {
        buildStars();
        asteroids();
        buildFloor();
        buildEntity({type:'a-plane',attributes:',newgame,-.45 1 -2,,,button,#ff2,.5,.1,.5',children:[{type:'a-text',attributes:',,0 .015 .02,,.3 .3 .3,,,,,,,,,exo2semibold,NEW GAME,,center'}]},document.querySelector('#a-scene'));
		this.data.battery = 100;
		var c=document.getElementById('stars');
        var ctx=c.getContext('2d');
        var stars = c.toDataURL("image/png");
        document.querySelector("#image-360").setAttribute('src', stars);
        document.querySelector("#image-360").setAttribute('repeat', '4 4');
        //loadLevel(2);
    },
	tick: function(){
		this.data.timer++;
		if (this.data.timer >= 10) {
			this.data.battery+=1;
			this.data.timer = 0;
			if(this.data.battery>100)this.data.battery=100;
		}
		if (this.data.batteryUI != null) {
            this.data.batteryUI.setAttribute('scale', this.data.battery / 100 + ' 1 1');
            this.data.batteryUI.setAttribute('position', (1 + (this.data.battery / 100 / 2)) + ' ' + this.data.batteryUI.object3D.position.y + ' ' + this.data.batteryUI.object3D.position.z);
        }
	}
});
AFRAME.registerComponent('right-controller', {
	schema: {
		rig: {type: 'selector'},
		hitbox: {type: 'selector'},
		door: {type: 'selector'},
		innerDoor: {type: 'selector'},
		doorPos: {type: 'vec3'},
		buttonPos: {type: 'vec3'},
		buttonPosX: {type: 'float'},
		buttonPosY: {type: 'float'},
		buttonPosZ: {type: 'float'},
	},
	init: function() {
		this.data.rig = document.querySelector('#rig');
		this.data.hitbox = document.querySelector('#hitbox');
		this.data.door = document.querySelector('#door');
		this.data.innerDoor = document.querySelector('#inner-door');
	},
	tick: function(){
		var el = this.el;
		var elPos = el.object3D.position;
		var rigPos = this.data.rig.object3D.position;
		var controllerX = rigPos.x - elPos.x;
		var controllerY = rigPos.y + elPos.y;
		var controllerZ = rigPos.z - elPos.z;
/*
		this.data.doorPos = this.data.door.object3D.position;
		this.data.buttonPosX = this.data.doorPos.x + this.data.hitbox.object3D.position.x;
		this.data.buttonPosY = this.data.doorPos.y + this.data.hitbox.object3D.position.y;
		this.data.buttonPosZ = this.data.doorPos.z + this.data.hitbox.object3D.position.z;
		this.data.buttonPos = new THREE.Vector3(this.data.buttonPosX, this.data.buttonPosY, this.data.buttonPosZ);

		if (collided(controllerX, controllerY, controllerZ, this.data.buttonPos, this.data.hitbox)) {
			this.data.innerDoor.setAttribute('closed', false);
			this.data.innerDoor.setAttribute('animation', {property:'position',to:'0 1.8 0',dur:500});
		}
		*/
	},
});
AFRAME.registerComponent('robot', {
	schema: {
		posX:{type:'number', default:0},
		posZ:{type:'number', default:1},
		dead:{type:'bool', default:false},
		path:{type:'array'},
		step:{type:'int',default:-1},
		speed:{type:'int',default:1000},
        timer:{type:'int',default:0},
	},
	init: function() {
		var el = this.el;
		this.data.path = botPaths[level][el.id.replace(/robot/,'')];
		this.step = -1;
		this.takeNextStep(el);
	},
	tick: function() {
        this.data.timer++;
		if (this.data.timer >= 100) {
			this.el.setAttribute("visible", false);
		}
		if (this.data.timer >= 80) {
			this.el.setAttribute("visible", true);
			this.data.timer = 0;
		}
	},
	takeNextStep: function(el){
		//var el = this.el;
        el.components.robot.data.step++;
		if (el.components.robot.data.step >= el.components.robot.data.path.length) el.components.robot.data.step = 0;
		var nextStep = el.components.robot.data.path[el.components.robot.data.step];
		if (nextStep.rot!=null){
            el.components.robot.turnTo(nextStep.rot,el);
		} else {
            el.components.robot.moveTo(nextStep.x,nextStep.z,el);
		}
	},
	turnTo: function(rot,el){
		//var el = this.el;
		if (!el.components.robot.data.dead){
			robotX = parseInt(Math.round(el.getAttribute('position').x/3));
			robotZ = parseInt(Math.round(el.getAttribute('position').z/3));
			el.removeAttribute('animation__moveTo');
			el.removeEventListener('animationcomplete__moveTo', nextMove[el.id]);
			el.setAttribute('animation__turnTo', {pauseEvents:'foundPlayer',resumeEvents:'fired',property:'rotation',to:'0 ' + rot + ' 0',loop:false,dur:el.components.robot.data.speed,easing:'linear'});
			el.addEventListener('animationcomplete__turnTo', nextTurn[el.id]=function(){
			    if(Math.round(el.object3D.rotation.y*180/Math.PI)==360)el.object3D.rotation.y=0;
                if(Math.round(el.object3D.rotation.y*180/Math.PI)==-360)el.object3D.rotation.y=0;
				el.components.robot.takeNextStep(el)
			});
		}
	},
	moveTo: function(x,z,el){
		//var el = this.el;
		if (!el.components.robot.data.dead){
			var deltaX = Math.abs(x - el.getAttribute('position').x);
			var deltaZ = Math.abs(z - el.getAttribute('position').z);
			var delta = Math.max(deltaX, deltaZ);
			el.removeAttribute('animation__turnTo');
			el.removeEventListener('animationcomplete__turnTo', nextTurn[el.id]);
			el.setAttribute('animation__moveTo', {pauseEvents:'foundPlayer',resumeEvents:'fired',property:'position',to:x + ' 0 ' + z,loop:false,dur:delta * el.components.robot.data.speed,easing:'linear'});
			el.addEventListener('animationcomplete__moveTo', nextMove[el.id]=function(){el.components.robot.takeNextStep(el)});
		}
	}
});
AFRAME.registerComponent('wallscreen', {
	schema: {
		timer:{type:'int',default:0},
		flash:{type:'bool',default:true}
	},
	init: function() {
		var el = this.el;
		if (Math.round(Math.random()*2) % 2 == 0) {
			el.setAttribute('position', '.08 .1 1.2');
			el.setAttribute('value', 'EMERGENCY ALERT');
			el.setAttribute('color', 'red');
			el.setAttribute('scale', '2 2 2');
		} else {
			this.data.flash = false;
			el.setAttribute('position', '.08 .33 1.2');
			el.setAttribute('value', getJunk());
			el.setAttribute('color', 'white');
			el.setAttribute('scale', '2 2 2');
			el.setAttribute('wrap-count', 400);
		}
	},
	tick: function() {
		var el = this.el;
		this.data.timer++;
		if (this.data.flash){
			if (this.data.timer >= 50) {
				el.setAttribute("visible", false);
			}
			if (this.data.timer >= 80) {
                //zzfx(...[,,539,0,.04,.29,1,1.92,,,567,.02,.02,,,,.04])
				el.setAttribute("visible", true);
				this.data.timer = 0;
			}
		}
	}
});
AFRAME.registerComponent('gaze', {
  dependencies: ['raycaster'],
  schema:{
  	robot:{type:'selector'},
  	so:{type:'selector'},
  },
  init: function () {
  	this.data.robot = this.el.parentEl.parentEl.parentEl.parentEl;//document.querySelector("#robot");
	this.el.addEventListener('raycaster-intersection', function (evt) {
		var robot = evt.srcElement.parentEl.parentEl.parentEl.parentEl;
		if ((evt.detail.intersections[0].object.el.id == 'player') || (evt.detail.intersections[0].object.el.id == 'holo')){
			if (!firing) {
				if (!robot.components.robot.data.dead) {
					if (hitPlayer(robot.object3D.position, evt.composedPath()[0].components.line.attrValue.end)) {
						this.so = evt.detail.intersections[0].object.el.id;
						currenttarget = this.so;
						ss(Math.floor(Math.random()*6)+5,robot.id);
						warmUp(robot.id);
						robot.emit('foundPlayer',{},true);
						var bothead = document.querySelector("#head"+robot.id);
						bothead.emit('foundPlayer',{},false);
					}
				}
			}
		}
	});
	this.el.addEventListener('raycaster-intersection-cleared', function(evt){
		if(this.so)this.so=null;
	});
  }
});
</script>
  </head>
  <body bgcolor="#000" id="body">
  	<canvas id="stars" style="display:none" height=1024 width=1024></canvas>
  	<canvas id="nebula" style="display:none" height=1024 width=1024></canvas>
    <canvas id="gradient" style="display:none" height=1024 width=1024></canvas>
    <canvas id="holocanvas" style="display:none" width=600 height=1200></canvas>
	<canvas id="c128" style="display:none" width=128 height=128></canvas>
 	<a-scene id='a-scene' background="color:#000" antialias='true' stats>
 		<a-entity id=game game></a-entity>
		<a-assets><img id="planet" src="earth.png"></a-assets>
		<a-entity id="ambient" light="type:ambient;color:#fff;intensity:.4"></a-entity>
		<a-entity light="type:directional;color:#fff;intensity:.5" rotation="-90 10 0"></a-entity>
		<a-sky id="image-360" radius="360" phi-start="140" segments-width=32 segments-height=10></a-sky>
		<a-entity id="ship"></a-entity>
		<a-entity id="rig" cameraRig position="0 0 0" rotation="0 90 0">
			<a-entity camera id="camera" wasd-controls="acceleration:150" look-controls="reverseMouseDrag: false" position="0 1.4 0">
				<a-cylinder class="collidable" height=3 visible=true position="0 1 0" id="player" radius=".5"></a-cylinder>
				<a-entity position="0 .3 -100" id="title1" color="#ffff82" text="font:exo2semibold;align:center;value:HUMAN" scale="3 3 3" animation="property:position;to:0 .3 -1;dur:2000"></a-entity>
				<a-entity position="0 .19 -100" id="title2" color="#ffff82" text="font:exo2semibold;align:center;value:NOT" scale="2 2 2" animation="property:position;to:0 .19 -1;dur:2000"></a-entity>
				<a-entity position="0 .1 -100" id="title3" color="#ffff82" text="font:exo2semibold;align:center;value:FOUND" scale="3 3 3" animation="property:position;to:0 .1 -1;dur:2000"></a-entity>
				<a-entity position="0 -.1 100" id="titles2" color="#ffff82" text='wrap-count:60;font:exo2semibold;align:center;value:In space, no one can hear you scream "This sucks!"' animation="property:position;to:0 -.1 -1;dur:2500"></a-entity>
				<a-entity position="0 -.2 -.6" id="log" text="font:exo2semibold;value:;align:center"></a-entity>
			</a-entity>
			<a-entity id="leftController" static-body="shape: sphere; sphereRadius: 0.02;" oculus-touch-controls="hand: left" tracked-controls="" teleport-controls="button:trigger;objects:.floor;cameraRig:#rig"></a-entity>
			<a-entity id="rightController" static-body="shape: sphere; sphereRadius: 0.02;" oculus-touch-controls="hand: right" tracked-controls="button:trigger;objects:.button;" right-controller laser-controls="objects:.button;"></a-entity>
		</a-entity>
		<!--<a-image id="holo" class="collidable" height=2 width=1 position="7 .8 3" opacity=".7" animation="property:rotation;from:0 -90 -5;to:0 -90 5;loop:true;dur:300;easing:linear;dir:alternate"></a-image>-->
	</a-scene>
</body>
</html>